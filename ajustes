-- Adiciona índices às tabelas temporárias para melhorar a performance de JOINs
CREATE CLUSTERED INDEX IDX_TMP_FILAS_NOM_FILR ON #TMP_FILAS_MENSAGERIA(NOM_FILR);
CREATE NONCLUSTERED INDEX IDX_TBFR6002_NOM_FILR ON #TBFR6002_CTRL_MSGR(NOM_FILR, DAT_HOR_INCU);

-- Ajusta filtros de data para evitar conversões custosas
SELECT FILA = A.NOM_FILR, MERCADO = B.TIPO, TOTAL = COUNT(1)
INTO #TMP_TOTAL
FROM #TBFR6002_CTRL_MSGR (NOLOCK) A
INNER JOIN #TMP_FILAS_MENSAGERIA B ON (A.NOM_FILR = B.NOM_FILR)
WHERE (A.DAT_HOR_INCU >= @DATABASE_START_DATE AND A.DAT_HOR_INCU < @DATABASE_END_DATE)
GROUP BY A.NOM_FILR, B.TIPO;

-- Reuso de tabelas temporárias para evitar recriação
SELECT FILA = A.NOM_FILR, MERCADO = B.TIPO, PROCESSADOS_SUCESSO = COUNT(1)
INTO #TMP_PROCESSADOS_SUCESSO
FROM #TMP_TOTAL T
WHERE DAT_HOR_PSST IS NOT NULL
GROUP BY A.NOM_FILR, B.TIPO;

-- Exemplo de ajuste na exibição final
SELECT NEWID() AS ID, 
       A.NOM_FILR, 
       A.DESCRICAO_FILA, 
       ISNULL(A.TIPO, 0) AS TIPO, 
       ISNULL(B.TOTAL, 0) AS TOTAL, 
       ISNULL(D.PENDENTE_PROCESSAMENTO, 0) AS PENDENTE_PROCESSAMENTO,
       ISNULL(C.PROCESSADOS_SUCESSO, 0) AS PROCESSADOS_SUCESSO
FROM #TMP_FILAS_MENSAGERIA A
LEFT JOIN #TMP_TOTAL B ON A.NOM_FILR = B.FILA
LEFT JOIN #TMP_PROCESSADOS_SUCESSO C ON A.NOM_FILR = C.FILA
ORDER BY A.TIPO, A.ORDEM, A.DESCRICAO_FILA;

-- Liberação imediata de tabelas temporárias
DROP TABLE #TMP_TOTAL, #TMP_PROCESSADOS_SUCESSO;
